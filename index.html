<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRVHOZX | é£ä¹¦è´¦å•åŠ©æ‰‹</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        /* 1. é£ä¹¦é£æ ¼åŸºç¡€æ ·å¼ */
        :root {
            --primary-color: #3370ff; /* é£ä¹¦è“ */
            --success-color: #34c759;
            --bg-color: #f5f6f7;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color); 
            margin: 0; 
            padding: 16px; 
            color: #1f2329;
            line-height: 1.5;
        }

        .container { 
            max-width: 100%; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(31,35,41,0.08); 
        }

        /* 2. æ ‡é¢˜ä¸è¯´æ˜é€‚é…çª„å± */
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 20px; margin: 0 0 8px 0; color: #1f2329; }
        .header p { font-size: 13px; color: #646a73; margin: 0; }

        /* 3. æŒ‰é’®ä¸ä¸Šä¼ åŒºä¼˜åŒ– */
        .upload-area { 
            border: 2px dashed #dee0e3; 
            padding: 30px 15px; 
            text-align: center; 
            border-radius: 6px; 
            background: #fafbfa; 
            cursor: pointer; 
            transition: all 0.2s;
        }
        .upload-area:hover { border-color: var(--primary-color); background: #f0f5ff; }
        
        .btn-group { display: flex; flex-direction: column; gap: 10px; margin: 20px 0; }
        .btn { 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            border: none; 
            font-weight: 500; 
            font-size: 14px;
            text-align: center;
        }
        .btn-download { background: var(--success-color); color: white; display: none; }

        /* 4. è¡¨æ ¼åŒºåŸŸï¼šå¢åŠ æ¨ªå‘æ»šåŠ¨ä»¥é€‚é…æ‰‹æœº/ä¾§è¾¹æ  */
        .table-wrapper { 
            overflow-x: auto; 
            border: 1px solid #dee0e3; 
            border-radius: 4px; 
            margin-top: 20px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; }
        table th { background: #f2f3f5; color: #646a73; padding: 10px; font-weight: 600; text-align: center; border-bottom: 1px solid #dee0e3; }
        table td { padding: 10px; border-bottom: 1px solid #f2f3f5; text-align: center; }
        
        /* åˆ—é¢œè‰²åŒºåˆ† */
        .calc-col { color: #d48806; font-weight: bold; background: #fffbe6; }
        .original-col { color: #34c759; font-weight: bold; background: #f6ffed; }
        .month-col { color: var(--primary-color); font-weight: bold; }

        #status { font-size: 13px; text-align: center; margin-bottom: 10px; color: var(--primary-color); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>BRVHOZX è´¦å•åŠ©æ‰‹</h1>
        <p>è‡ªåŠ¨è¯†åˆ«å…¬å¸ | æœˆä»½æ ¸ç®— | å‰”é™¤æ±‡æ€»</p>
    </div>

    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <span style="color:var(--primary-color); font-weight:bold;">ç‚¹å‡»é€‰æ‹©å¤šä¸ªè´¦å•æ–‡ä»¶</span>
        <p style="font-size:12px; color:#999; margin-top:5px;">æ”¯æŒå®‰é€Ÿã€é€Ÿç›ã€å¾·å®ç­‰æ ¼å¼</p>
        <input type="file" id="fileInput" accept=".xlsx, .xls" multiple style="display:none">
    </div>

    <div id="status"></div>

    <div class="btn-group">
        <button class="btn btn-download" id="downloadBtn">ğŸ“¥ å¯¼å‡ºåˆå¹¶è¡¨æ ¼</button>
    </div>
    
    <div class="table-wrapper" id="previewArea"></div>
</div>

<script>
    let processedRows = [];
    const HEADERS = ["FBAç¼–å·", "ä¸šåŠ¡æ—¶é—´", "å¼€èˆ¹æ—¶é—´", "é€’é€æ—¶é—´", "æ—¶æ•ˆ", "æ¸ é“åç§°", "é‡é‡", "å•ä»·", "è®¡ç®—é‡‘é¢", "åº”æ”¶é‡‘é¢", "å…¬å¸åç§°", "æ—¥æœŸ"];

    document.getElementById('fileInput').addEventListener('change', async function(e) {
        const files = e.target.files;
        if (!files.length) return;
        processedRows = [];
        document.getElementById('status').innerText = `æ­£åœ¨å¤„ç† ${files.length} ä¸ªæ–‡ä»¶...`;

        for (let file of files) {
            const data = await file.arrayBuffer();
            const wb = XLSX.read(data, {type: 'array', cellDates: true});
            const ws = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(ws, {header: 1, defval: ""});
            smartExtract(json);
        }
        renderPreview();
    });

    function smartExtract(rows) {
        // è¯†åˆ«å…¬å¸
        let company = "æœªçŸ¥ç‰©æµ";
        const txt = JSON.stringify(rows);
        if (txt.includes("é€Ÿç›")) company = "é€Ÿç›ç‰©æµ";
        else if (txt.includes("å¾·å®å®‰è¾¾")) company = "å¾·å®å®‰è¾¾";
        else if (txt.includes("å®‰é€Ÿ")) company = "å®‰é€Ÿå›½é™…";

        // å®šä½è¡¨å¤´
        let hIdx = rows.findIndex(r => r.some(c => ["FBAç¼–å·", "å®¢æˆ·å•å·", "åºå·"].includes(String(c).trim())));
        if (hIdx === -1) return;

        const headers = rows[hIdx].map(h => String(h || "").trim());
        const data = rows.slice(hIdx + 1);

        data.forEach(row => {
            const rowStr = JSON.stringify(row);
            // å‰”é™¤ï¼šæ±‡æ€»è¡Œã€ç©ºè¡Œã€å¤‡æ³¨è¡Œ
            if (/åˆè®¡|æ€»è®¡|Total|æœŸæ€»è®¡|åº”æ”¶æ€»è®¡/.test(rowStr) || row.filter(c => c !== "").length < 3) return;

            let obj = {};
            headers.forEach((h, i) => { if(h) obj[h] = row[i]; });

            // æ ¸å¿ƒæ•°å€¼è§£æ
            let w = parseFloat(obj["é‡é‡"] || obj["è®¡è´¹é‡"] || obj["ç»“ç®—é‡(KG)"] || obj["è®¡è´¹é‡é‡"] || 0) || 0;
            let p = parseFloat(obj["å•ä»·"] || obj["è¿è´¹å•ä»·"] || 0) || 0;
            let sourceDate = obj["æ—¥æœŸ"] || obj["ä¸šåŠ¡æ—¶é—´"] || obj["å®é™…åˆ°ä»“æ—¥æœŸ"] || obj["æ‹£è´§æ—¶é—´"];

            let finalItem = {
                "FBAç¼–å·": obj["FBAç¼–å·"] || obj["å®¢æˆ·å•å·"] || obj["è¿å•å·"] || "",
                "ä¸šåŠ¡æ—¶é—´": fmtD(obj["ä¸šåŠ¡æ—¶é—´"] || obj["å®é™…åˆ°ä»“æ—¥æœŸ"] || obj["æ‹£è´§æ—¶é—´"]),
                "å¼€èˆ¹æ—¶é—´": fmtD(obj["å¼€èˆ¹æ—¥æœŸ"] || obj["å¼€èˆ¹æ—¶é—´"]),
                "é€’é€æ—¶é—´": fmtD(obj["ç­¾æ”¶æ—¶é—´"] || obj["é€’é€æ—¶é—´"]),
                "æ—¶æ•ˆ": obj["æ—¶æ•ˆ"] || "",
                "æ¸ é“åç§°": obj["æ¸ é“åç§°"] || obj["ç‰©æµæ¸ é“"] || obj["äº§å“"] || obj["æ¸ é“"] || "",
                "é‡é‡": w,
                "å•ä»·": p,
                "è®¡ç®—é‡‘é¢": (w * p).toFixed(2),
                "åº”æ”¶é‡‘é¢": obj["åº”æ”¶é‡‘é¢"] || obj["æ€»é‡‘é¢"] || obj["è¿è´¹åˆè®¡"] || "",
                "å…¬å¸åç§°": company,
                "æ—¥æœŸ": fmtM(sourceDate) // å¼ºåˆ¶æœˆä»½
            };

            if (finalItem["FBAç¼–å·"]) processedRows.push(finalItem);
        });
    }

    function fmtD(v) {
        if (!v) return "";
        let d = v instanceof Date ? v : new Date(v);
        if (isNaN(d.getTime())) return v;
        return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
    }

    function fmtM(v) {
        let f = fmtD(v);
        return (f && f.length >= 7) ? f.substring(0, 7) : f;
    }

    function renderPreview() {
        if (!processedRows.length) return;
        let h = '<table><thead><tr>' + HEADERS.map(i => `<th>${i}</th>`).join('') + '</tr></thead><tbody>';
        processedRows.forEach(r => {
            h += '<tr>' + HEADERS.map(i => {
                let cls = i === "è®¡ç®—é‡‘é¢" ? 'calc-col' : i === "åº”æ”¶é‡‘é¢" ? 'original-col' : i === "æ—¥æœŸ" ? 'month-col' : '';
                return `<td class="${cls}">${r[i] || ''}</td>`;
            }).join('') + '</tr>';
        });
        document.getElementById('previewArea').innerHTML = h + '</tbody></table>';
        document.getElementById('downloadBtn').style.display = 'block';
        document.getElementById('status').innerText = `âœ… å·²å¤„ç† ${processedRows.length} æ¡æ˜ç»†`;
    }

    document.getElementById('downloadBtn').onclick = function() {
        const ws = XLSX.utils.json_to_sheet(processedRows, { header: HEADERS });
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "å¯¹è´¦æ±‡æ€»");
        XLSX.writeFile(wb, `BRVHOZX_é£ä¹¦å¯¹è´¦å•_${new Date().toISOString().split('T')[0]}.xlsx`);
    };
</script>

</body>
</html>