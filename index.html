<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BRVHOZX | é£ä¹¦è´¦å•åŠ©æ‰‹</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #3370ff; 
            --success-color: #34c759;
            --bg-color: #f5f6f7;
            --border-color: #dee0e3;
        }

        body { 
            font-family: -apple-system, system-ui, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color); 
            margin: 0; 
            padding: 12px; 
            color: #1f2329;
        }

        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 16px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(31,35,41,0.06); 
        }

        .header { text-align: center; margin-bottom: 16px; border-bottom: 1px solid var(--border-color); padding-bottom: 12px; }
        .header h1 { font-size: 18px; margin: 0 0 4px 0; color: var(--primary-color); }
        .header p { font-size: 12px; color: #646a73; margin: 0; }

        .upload-area { 
            border: 2px dashed var(--border-color); 
            padding: 24px 12px; 
            text-align: center; 
            border-radius: 6px; 
            background: #fafbfa; 
            cursor: pointer; 
            transition: border 0.2s;
        }
        .upload-area:active { background: #f0f5ff; border-color: var(--primary-color); }
        
        #status { font-size: 13px; text-align: center; margin: 12px 0; color: var(--primary-color); min-height: 1.2em; }

        .btn-group { margin: 12px 0; }
        .btn { 
            width: 100%;
            padding: 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            border: none; 
            font-weight: 500; 
            font-size: 14px;
            background: var(--success-color); 
            color: white; 
            display: none; 
        }

        /* è¡¨æ ¼å®¹å™¨é€‚é… */
        .table-wrapper { 
            overflow-x: auto; 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            margin-top: 12px;
            -webkit-overflow-scrolling: touch;
        }
        table { width: 100%; border-collapse: collapse; font-size: 11px; white-space: nowrap; }
        table th { background: #f2f3f5; padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); }
        table td { padding: 8px; border-bottom: 1px solid #f2f3f5; text-align: center; }
        
        .calc-col { color: #d48806; font-weight: bold; background: #fffbe6; }
        .original-col { color: #34c759; font-weight: bold; background: #f6ffed; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>BRVHOZX è´¦å•åŠ©æ‰‹</h1>
        <p>é€‚é…å®‰é€Ÿ/é€Ÿç›/å¾·å® | è‡ªåŠ¨æ ¸ç®—é‡‘é¢</p>
    </div>

    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <span style="font-size: 15px; color:var(--primary-color);">ğŸ“‚ ç‚¹å‡»é€‰æ‹©è´¦å•æ–‡ä»¶</span>
        <p style="font-size:11px; color:#999; margin-top:4px;">æ”¯æŒå¤šé€‰ .xlsx / .xls æ–‡ä»¶</p>
        <input type="file" id="fileInput" accept=".xlsx, .xls" multiple style="display:none">
    </div>

    <div id="status">å‡†å¤‡å°±ç»ª</div>

    <button class="btn" id="downloadBtn">ğŸ“¥ å¯¼å‡ºåˆå¹¶åçš„ Excel</button>
    
    <div class="table-wrapper" id="previewArea"></div>
</div>

<script>
    let processedRows = [];
    const HEADERS = ["FBAç¼–å·", "ä¸šåŠ¡æ—¶é—´", "å¼€èˆ¹æ—¶é—´", "é€’é€æ—¶é—´", "æ—¶æ•ˆ", "æ¸ é“åç§°", "é‡é‡", "å•ä»·", "è®¡ç®—é‡‘é¢", "åº”æ”¶é‡‘é¢", "å…¬å¸åç§°", "æœˆä»½"];

    document.getElementById('fileInput').addEventListener('change', async function(e) {
        const files = e.target.files;
        if (!files.length) return;
        
        processedRows = [];
        document.getElementById('status').innerText = `æ­£åœ¨å¤„ç† ${files.length} ä¸ªæ–‡ä»¶...`;

        try {
            for (let file of files) {
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data, {type: 'array', cellDates: true});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(ws, {header: 1, defval: ""});
                smartExtract(json);
            }
            renderPreview();
        } catch (err) {
            document.getElementById('status').innerText = "âŒ å¤„ç†å‡ºé”™ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼";
            console.error(err);
        }
    });

    function smartExtract(rows) {
        let company = "æœªçŸ¥ç‰©æµ";
        const contentStr = JSON.stringify(rows);
        if (contentStr.includes("é€Ÿç›")) company = "é€Ÿç›ç‰©æµ";
        else if (contentStr.includes("å¾·å®")) company = "å¾·å®å®‰è¾¾";
        else if (contentStr.includes("å®‰é€Ÿ")) company = "å®‰é€Ÿå›½é™…";

        let headerRowIdx = rows.findIndex(r => r.some(c => ["FBAç¼–å·", "å®¢æˆ·å•å·", "å•å·"].includes(String(c).trim())));
        if (headerRowIdx === -1) return;

        const fileHeaders = rows[headerRowIdx].map(h => String(h || "").trim());
        const dataRows = rows.slice(headerRowIdx + 1);

        dataRows.forEach(row => {
            const rowStr = JSON.stringify(row);
            if (/åˆè®¡|æ€»è®¡|Total|æœŸæ€»è®¡/.test(rowStr) || row.filter(c => c !== "").length < 3) return;

            let rowData = {};
            fileHeaders.forEach((h, i) => { if(h) rowData[h] = row[i]; });

            let weight = parseFloat(rowData["é‡é‡"] || rowData["è®¡è´¹é‡"] || rowData["ç»“ç®—é‡(KG)"] || 0) || 0;
            let price = parseFloat(rowData["å•ä»·"] || rowData["è¿è´¹å•ä»·"] || 0) || 0;
            let dateVal = rowData["æ—¥æœŸ"] || rowData["ä¸šåŠ¡æ—¶é—´"] || rowData["å®é™…åˆ°ä»“æ—¥æœŸ"] || rowData["æ‹£è´§æ—¶é—´"];

            let item = {
                "FBAç¼–å·": rowData["FBAç¼–å·"] || rowData["å®¢æˆ·å•å·"] || rowData["è¿å•å·"] || "",
                "ä¸šåŠ¡æ—¶é—´": formatDate(dateVal),
                "å¼€èˆ¹æ—¶é—´": formatDate(rowData["å¼€èˆ¹æ—¥æœŸ"] || rowData["å¼€èˆ¹æ—¶é—´"]),
                "é€’é€æ—¶é—´": formatDate(rowData["ç­¾æ”¶æ—¶é—´"] || rowData["é€’é€æ—¶é—´"]),
                "æ—¶æ•ˆ": rowData["æ—¶æ•ˆ"] || "",
                "æ¸ é“åç§°": rowData["æ¸ é“åç§°"] || rowData["ç‰©æµæ¸ é“"] || rowData["äº§å“"] || "",
                "é‡é‡": weight,
                "å•ä»·": price,
                "è®¡ç®—é‡‘é¢": (weight * price).toFixed(2),
                "åº”æ”¶é‡‘é¢": rowData["åº”æ”¶é‡‘é¢"] || rowData["æ€»é‡‘é¢"] || rowData["è¿è´¹åˆè®¡"] || 0,
                "å…¬å¸åç§°": company,
                "æœˆä»½": formatMonth(dateVal)
            };

            if (item["FBAç¼–å·"]) processedRows.push(item);
        });
    }

    function formatDate(v) {
        if (!v) return "";
        let d = v instanceof Date ? v : new Date(v);
        if (isNaN(d.getTime())) return v;
        return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
    }

    function formatMonth(v) {
        let f = formatDate(v);
        return (typeof f === 'string' && f.length >= 7) ? f.substring(0, 7) : "";
    }

    function renderPreview() {
        if (!processedRows.length) {
            document.getElementById('status').innerText = "æœªè¯†åˆ«åˆ°æœ‰æ•ˆæ•°æ®";
            return;
        }
        let html = '<table><thead><tr>' + HEADERS.map(i => `<th>${i}</th>`).join('') + '</tr></thead><tbody>';
        processedRows.forEach(r => {
            html += '<tr>' + HEADERS.map(i => {
                let cls = i === "è®¡ç®—é‡‘é¢" ? 'calc-col' : i === "åº”æ”¶é‡‘é¢" ? 'original-col' : '';
                return `<td class="${cls}">${r[i] || ''}</td>`;
            }).join('') + '</tr>';
        });
        document.getElementById('previewArea').innerHTML = html + '</tbody></table>';
        document.getElementById('downloadBtn').style.display = 'block';
        document.getElementById('status').innerText = `âœ… å·²æˆåŠŸå¤„ç† ${processedRows.length} æ¡æ•°æ®`;
    }

    document.getElementById('downloadBtn').onclick = function() {
        const ws = XLSX.utils.json_to_sheet(processedRows, { header: HEADERS });
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "å¯¹è´¦æ±‡æ€»");
        XLSX.writeFile(wb, `BRVHOZX_å¯¹è´¦å•_${new Date().toLocaleDateString()}.xlsx`);
    };
</script>
</body>
</html>